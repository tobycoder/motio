{% extends 'base.html' %}
{% macro iso_date(value) -%}
    {%- if value is string -%}
        {{ value }}
    {%- elif value -%}
        {{ value.strftime('%Y-%m-%d') }}
    {%- else -%}{%- endif -%}
{%- endmacro %}
{% macro display_date(value, default='') -%}
    {%- if value is string -%}
        {{ value }}
    {%- elif value -%}
        {{ value.strftime('%d-%m-%Y') }}
    {%- else -%}
        {{ default }}
    {%- endif -%}
{%- endmacro %}
{% block content %}
{% set stats = namespace(total=0) %}
{% set indieners = namespace(values=[]) %}
{% for item in items %}
  {% set m = item.motie if item is mapping and 'motie' in item else item %}
  {% set stats.total = stats.total + 1 %}
  {% if m.indiener and m.indiener.naam and (m.indiener.naam not in indieners.values) %}
    {% set indieners.values = indieners.values + [m.indiener.naam] %}
  {% endif %}
{% endfor %}

<div class="sticky top-0 page-chrome-low bg-white/90 backdrop-blur border-b shadow-sm">
  <div class="mx-auto max-w-7xl px-4 py-4 flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
    <div>
      <p class="text-sm uppercase tracking-wide text-gray-500">Moties</p>
      <h1 class="text-2xl font-semibold text-gray-900">{{ title or 'Overzicht' }}</h1>
      <div class="mt-3 flex flex-wrap gap-2 text-sm text-gray-500">
        <span class="inline-flex items-center gap-1 rounded-full bg-gray-100 px-3 py-1">{{ stats.total }} moties</span>
      </div>
    </div>
    <a href="{{ url_for('moties.toevoegen') }}" class="inline-flex items-center justify-center gap-2 rounded-md bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-black transition">
      <i class="fa fa-plus"></i> Nieuwe motie
    </a>
  </div>
</div>

<section class="mx-auto max-w-7xl px-4 py-6 space-y-6">
  <div class="rounded-2xl border border-gray-200 bg-white shadow-sm">
    <div class="grid gap-4 p-6 lg:grid-cols-4 lg:items-end">
      <div class="lg:col-span-2 relative">
        <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-gray-400"><i class="fa fa-search"></i></span>
        <input id="motie-search" type="search" placeholder="Zoek op titel, status, partij..."
               class="w-full rounded-lg border border-gray-300 bg-white pl-10 pr-4 py-2 text-sm text-gray-700 shadow-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/20 transition" />
      </div>
      <div>
        <label for="filter-meeting" class="block text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">Datum vergadering</label>
        <input id="filter-meeting" type="date" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/20 transition" />
      </div>
      <div>
        <label for="filter-created" class="block text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">Aangemaakt op</label>
        <input id="filter-created" type="date" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/20 transition" />
      </div>
      <div class="lg:col-span-4">
        <label for="filter-indiener" class="block text-xs font-semibold uppercase tracking-wide text-gray-500 mb-1">Indiener</label>
        <select id="filter-indiener" class="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm bg-white focus:border-gray-900 focus:outline-none focus:ring-2 focus:ring-gray-900/20 transition">
          <option value="">Alle indieners</option>
          {% for naam in indieners.values|sort %}
            <option value="{{ naam|lower }}">{{ naam }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white shadow-sm">
    <table class="min-w-full text-sm text-left text-gray-700">
      <thead class="text-xs uppercase bg-gray-50 text-gray-500">
        <tr>
          <th class="px-3 py-3">Titel</th>
          <th class="px-6 py-3 hidden md:table-cell">Aanmaakdatum</th>
          <th class="px-6 py-3 hidden md:table-cell">Dag vergadering</th>
          <th class="px-6 py-3 hidden lg:table-cell">Indiener</th>
          <th class="px-6 py-3 hidden lg:table-cell">Mede-indiener</th>
          <th class="px-6 py-3 hidden lg:table-cell">Relatie</th>
        </tr>
      </thead>
      <tbody>
        {% for item in items %}
          {% set m = item.motie if item is mapping and 'motie' in item else item %}
          {% set relation = item.relation if item is mapping and 'relation' in item else None %}
          {% set share_permission = item.share_permission if item is mapping and 'share_permission' in item else None %}
          {% set meeting_date = iso_date(m.gemeenteraad_datum)|trim %}
          {% set created_date = iso_date(m.created_at)|trim %}
          {% set indiener_naam = m.indiener.naam if m.indiener and m.indiener.naam else '' %}
          {% set search_blob = (m.titel ~ ' ' ~ (m.status or '') ~ ' ' ~ (indiener_naam) ~ ' ' ~ (m.party.naam if m.party and m.party.naam else '') ~ ' ' ~ (meeting_date) ~ ' ' ~ (created_date))|lower %}
          <tr data-motie-row
              data-search="{{ search_blob }}"
              data-meeting="{{ meeting_date }}"
              data-created="{{ created_date }}"
              data-indiener="{{ indiener_naam|lower }}"
              class="bg-white border-b border-gray-200 hover:bg-gray-50 transition">
            <td class="px-3 py-4 font-medium text-blue-600 whitespace-nowrap">
              <a href="{{ url_for('moties.bekijken', motie_id=m.id) }}" class="hover:underline">{{ m.titel }}</a>
              <div class="mt-1 text-xs text-gray-500 md:hidden">
                {{ created_date }} • {{ m.party.naam if m.party and m.party.naam else '-' }} • {{ m.status or '-' }}
              </div>
            </td>
            <td class="px-6 py-4 hidden md:table-cell">{{ display_date(m.created_at)|trim }}</td>
            <td class="px-6 py-4 hidden md:table-cell">{{ display_date(m.gemeenteraad_datum, '-')|trim }}</td>
            <td class="px-6 py-4 hidden lg:table-cell">{{ indiener_naam or '-' }}</td>
            <td class="px-6 py-4 hidden lg:table-cell">
              {% if m.mede_indieners %}
                {% for mx in m.mede_indieners %}
                  <span class="px-2 py-0.5 bg-blue-100 text-gray-700 rounded text-xs inline-block mr-1">{{ mx.partij.naam if mx.partij and mx.partij.naam else mx.naam }}</span>
                {% endfor %}
              {% else %}
                <span class="text-gray-400">-</span>
              {% endif %}
            </td>
            <td class="px-6 py-4 hidden lg:table-cell">
              {% if relation == 'indiener' %}
                <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-800">Indiener</span>
              {% elif relation == 'mede_indiener' %}
                <span class="px-2 py-1 text-xs rounded bg-green-100 text-green-800">Mede-indiener</span>
              {% elif relation == 'gedeeld' %}
                <span class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-800">
                  Gedeeld{% if share_permission %}: {{ share_permission }}{% endif %}
                </span>
              {% elif relation == 'superadmin' %}
                <span class="px-2 py-1 text-xs rounded bg-amber-100 text-amber-800">Alle moties</span>
              {% else %}
                <span class="text-gray-400">-</span>
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div id="motie-empty-state" class="hidden rounded-2xl border border-dashed border-gray-300 bg-gray-50 px-6 py-12 text-center text-gray-500">
    <i class="fa fa-list text-3xl mb-4"></i>
    <p>Geen moties gevonden voor deze filters.</p>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const rows = Array.from(document.querySelectorAll('[data-motie-row]'));
    const searchInput = document.getElementById('motie-search');
    const meetingInput = document.getElementById('filter-meeting');
    const createdInput = document.getElementById('filter-created');
    const indienerSelect = document.getElementById('filter-indiener');
    const emptyState = document.getElementById('motie-empty-state');

    const applyFilters = () => {
      const searchValue = (searchInput.value || '').trim().toLowerCase();
      const meetingValue = (meetingInput.value || '').trim();
      const createdValue = (createdInput.value || '').trim();
      const indienerValue = (indienerSelect.value || '').trim();

      let visibleCount = 0;

      rows.forEach(row => {
        const matchesSearch = !searchValue || row.dataset.search.includes(searchValue);
        const matchesMeeting = !meetingValue || row.dataset.meeting === meetingValue;
        const matchesCreated = !createdValue || row.dataset.created === createdValue;
        const matchesIndiener = !indienerValue || row.dataset.indiener === indienerValue;

        const visible = matchesSearch && matchesMeeting && matchesCreated && matchesIndiener;
        row.classList.toggle('hidden', !visible);
        if (visible) visibleCount += 1;
      });

      emptyState.classList.toggle('hidden', visibleCount !== 0);
    };

    [searchInput, meetingInput, createdInput, indienerSelect].forEach(el => {
      el && el.addEventListener(el.tagName === 'SELECT' ? 'change' : 'input', () => {
        window.requestAnimationFrame(applyFilters);
      });
    });

    applyFilters();
  });
</script>
{% endblock %}

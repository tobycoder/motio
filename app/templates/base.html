<html>

<head>
    <style>
.tc-del { text-decoration: line-through; background: #fee2e2; color: #991b1b; }
.tc-ins { text-decoration: none; background: #dcfce7; border-bottom: 2px solid #16a34a; color: #065f46; }
</style>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="color-scheme" content="light dark">
    <title>{% if title %}{{ title }} - {{ tenant_name or 'Motio' }}{% else %}{% block title %}{{ tenant_name or 'Motio' }}{% endblock %}{% endif %}</title>
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}">
    <link rel="shortcut icon" href="{{ url_for('static', filename='img/favicon.png') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
    <!-- Tailwind via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">
    <style>
        /* Tailwind-achtige look via extra class op de container */
        .custom-choices .choices__inner {
            border: 1px solid #d1d5db;
            border-radius: .5rem;
            padding: .375rem .5rem;
            min-height: 2.5rem;
            background: #f9fafb;
        }

        .custom-choices.is-focused .choices__inner,
        .custom-choices.is-open .choices__inner {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgb(59 130 246 / .5);
            background: #fff;
        }

        .custom-choices .choices__list--multiple .choices__item {
            background: #e5e7eb;
            color: #111827;
            border: 1px solid #d1d5db;
            border-radius: .375rem;
            margin: .25rem;
            padding: .125rem .5rem;
        }

        .custom-choices .choices__button {
            border-left: 1px solid #9ca3af;
        }

        .custom-choices .choices__list--dropdown {
            border: 1px solid #d1d5db;
            border-radius: .5rem;
        }

        .custom-choices .choices__list--dropdown .choices__item--selectable.is-highlighted {
            background: #eff6ff;
            color: #1f2937;
        }

          :root{
                /* hoogte van je navbar; pas aan als hij hoger is */
            --nav-h: 56px;
            }
            @media (min-width: 768px){
            :root{ --nav-h: 64px; }
            }

        [modal-backdrop],
        [data-modal-backdrop],
        .modal-backdrop {
            z-index: 3000 !important;   /* Forceer overlay boven alles */
        }
        .modal-topmost,
        .modal-topmost * {
            z-index: 3010 !important;
        }

        body.modal-open .nav-root,
        body.modal-open .nav-root *,
        body.modal-open .page-chrome-low,
        body.modal-open .content-dropdown,
        body.modal-open .content-dropdown *,
        body.modal-open .ios-bottom-nav {
            z-index: 20 !important;
            pointer-events: none !important;
        }

        .app-background {
            position: fixed;
            inset: 0;
            overflow: hidden;
            z-index: -10;
            pointer-events: none;
            background: radial-gradient(circle at top, rgba(236, 252, 255, 0.75), transparent 55%),
                        radial-gradient(circle at bottom, rgba(226, 232, 240, 0.6), transparent 60%);
        }
        .app-background::after {
            content: "";
            position: absolute;
            inset: 0;
            background: linear-gradient(160deg,
                        rgba(255, 255, 255, 0.75),
                        rgba(248, 249, 255, 0.45) 45%,
                        rgba(224, 231, 255, 0.35));
            mix-blend-mode: screen;
        }
        .app-background::before {
            content: "";
            position: absolute;
            inset: -25%;
            background: conic-gradient(
                from 0deg,
                rgba(99, 102, 241, 0.42),
                rgba(45, 212, 191, 0.32),
                rgba(168, 85, 247, 0.36),
                rgba(59, 130, 246, 0.4),
                rgba(99, 102, 241, 0.42)
            );
            filter: blur(130px);
            opacity: 0.7;
            animation: appStripeSpin 18s linear infinite;
        }
        .app-gradient-overlay {
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at 25% 20%, rgba(255, 255, 255, 0.55), transparent 60%),
                        radial-gradient(circle at 75% 25%, rgba(226, 232, 240, 0.55), transparent 65%),
                        radial-gradient(circle at 50% 80%, rgba(191, 219, 254, 0.48), transparent 60%);
            background-size: 130% 130%;
            animation: appGradientShift 16s ease-in-out infinite alternate;
            mix-blend-mode: lighten;
        }
        .app-gradient-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0.75;
            filter: blur(120px);
            mix-blend-mode: screen;
        }
        .app-blob {
            position: absolute;
            width: 34rem;
            height: 34rem;
            filter: blur(110px);
            opacity: 0.6;
            border-radius: 9999px;
            transform: translate3d(0, 0, 0);
        }
        .app-blob--one {
            top: -10rem;
            left: -6rem;
            background: radial-gradient(circle at 25% 25%, #4338ca, rgba(67, 56, 202, 0));
            animation: appBlobDriftOne 12s ease-in-out infinite alternate;
        }
        .app-blob--two {
            bottom: -12rem;
            right: -8rem;
            background: radial-gradient(circle at 70% 30%, #0ea5e9, rgba(14, 165, 233, 0));
            animation: appBlobDriftTwo 14s ease-in-out infinite alternate;
        }
        .app-blob--three {
            top: 40%;
            left: 35%;
            background: radial-gradient(circle at 30% 70%, #a855f7, rgba(168, 85, 247, 0));
            animation: appBlobDriftThree 18s ease-in-out infinite alternate;
        }

        @keyframes appStripeSpin {
            0% { transform: rotate(0deg) scale(1); opacity: 0.6; }
            50% { opacity: 0.68; }
            100% { transform: rotate(360deg) scale(1); opacity: 0.6; }
        }
        @keyframes appBlobDriftOne {
            0% { transform: translate3d(-12%, 0, 0) scale(1); }
            50% { transform: translate3d(6%, 12%, 0) scale(1.08); opacity: 0.68; }
            100% { transform: translate3d(-4%, 20%, 0) scale(1.04); opacity: 0.6; }
        }
        @keyframes appBlobDriftTwo {
            0% { transform: translate3d(8%, 0, 0) scale(1); }
            50% { transform: translate3d(-6%, -10%, 0) scale(1.1); opacity: 0.62; }
            100% { transform: translate3d(4%, 8%, 0) scale(1.02); opacity: 0.55; }
        }
        @keyframes appBlobDriftThree {
            0% { transform: translate3d(-8%, -6%, 0) scale(1); }
            50% { transform: translate3d(4%, 4%, 0) scale(1.08); opacity: 0.64; }
            100% { transform: translate3d(-2%, 10%, 0) scale(1.05); opacity: 0.58; }
        }
        @keyframes appGradientShift {
            0% { transform: scale(1) translate3d(-4%, -2%, 0); }
            50% { transform: scale(1.05) translate3d(4%, 3%, 0); opacity: 0.85; }
            100% { transform: scale(1.04) translate3d(-2%, 4%, 0); }
        }

        @media (prefers-reduced-motion: reduce) {
            .app-background::before,
            .app-gradient-overlay,
            .app-blob {
                animation: none !important;
            }
            .app-gradient-canvas {
                display: none;
            }
        }

        .sticky-surface {
            position: sticky;
            top: var(--nav-h);
            z-index: 110;
            padding: 0.5rem 0;
        }
        .sticky-surface__inner {
            --sticky-max-width: 80rem;
            width: min(var(--sticky-max-width), calc(100% - 2rem));
            max-width: var(--sticky-max-width);
            margin: 0 auto;
            padding: 1rem 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.78);
            backdrop-filter: blur(18px);
            box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12);
        }
        .sticky-surface__inner {
            border-radius: 1rem;
        }
        .sticky-surface__inner--square {
            border-radius: 0;
        }
        .sticky-surface__inner--compact {
            --sticky-max-width: 64rem;
        }
        .sticky-surface__inner--narrow {
            --sticky-max-width: 48rem;
        }
        .dark .sticky-surface__inner {
            background: rgba(15, 23, 42, 0.82);
            border-color: rgba(51, 65, 85, 0.6);
            box-shadow: 0 22px 46px rgba(15, 23, 42, 0.55);
        }
        .sticky-surface--flush {
            padding-top: 0;
            padding-bottom: 0;
        }
        .sticky-surface--flush .sticky-surface__inner {
            border-radius: 0;
        }
        @media (max-width: 768px) {
            .sticky-surface {
                padding: 0.35rem 0;
            }
            .sticky-surface__inner {
                width: min(var(--sticky-max-width), calc(100% - 1.25rem));
                padding: 0.85rem 1.125rem;
                border-radius: 0.85rem;
            }
        }

        .nav-root { z-index: 1200; position: relative; }
        .nav-dropdown, .nav-dropdown * { z-index: 1200 !important; }
        .nav-dropdown-panel { z-index: 1400 !important; }
        .nav-dropdown-panel a { position: relative; z-index: 1; }
        @media (max-width: 767px) {
            .nav-dropdown-panel {
                position: static !important;
                width: 100% !important;
                margin-top: 0;
                box-shadow: none !important;
                border-width: 0 !important;
            }
            .nav-dropdown-panel ul {
                margin-top: 0;
            }
            #navbar-dropdown.ios-nav {
                position: absolute;
                top: calc(var(--nav-h) + 6px);
                left: 50%;
                transform: translateX(-50%);
                width: calc(100% - 2rem);
                background: rgba(248, 250, 252, 0.96);
                border: 1px solid rgba(148, 163, 184, 0.18);
                border-radius: 22px;
                box-shadow: 0 18px 40px rgba(15, 23, 42, 0.16);
                backdrop-filter: blur(18px);
                padding: 0.35rem 0;
                max-width: 24rem;
            }
            #navbar-dropdown.ios-nav ul {
                border: none !important;
                padding: 0 !important;
                background: transparent !important;
                gap: 0.25rem;
            }
            #navbar-dropdown.ios-nav li {
                margin: 0;
            }
            #navbar-dropdown.ios-nav button,
            #navbar-dropdown.ios-nav a {
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 0.9rem 1.4rem;
                font-weight: 500;
                background: transparent;
                border-bottom: 1px solid rgba(148, 163, 184, 0.12);
            }
            #navbar-dropdown.ios-nav li:last-child > a {
                border-bottom: none;
            }
            #navbar-dropdown.ios-nav button:hover,
            #navbar-dropdown.ios-nav a:hover {
                background: rgba(148, 163, 184, 0.14);
            }
            #navbar-dropdown.ios-nav .ios-chevron {
                width: 0.75rem;
                height: 0.75rem;
                opacity: 0.6;
            }
            #navbar-dropdown.ios-nav .nav-dropdown-panel {
                background: rgba(248, 250, 252, 0.96);
                border-radius: 18px;
                border: 1px solid rgba(148, 163, 184, 0.16);
                margin: 0.35rem 1rem;
                box-shadow: inset 0 0 0 rgba(0, 0, 0, 0);
            }
            #navbar-dropdown.ios-nav .nav-dropdown-panel ul {
                padding: 0.35rem 0;
            }
            #navbar-dropdown.ios-nav .nav-dropdown-panel a {
                padding: 0.85rem 1.1rem;
                border-bottom: 1px solid rgba(148, 163, 184, 0.12);
            }
            #navbar-dropdown.ios-nav .nav-dropdown-panel a:last-child {
                border-bottom: none;
            }
            .ios-bottom-nav {
                position: fixed;
                bottom: env(safe-area-inset-bottom, 12px);
                left: 50%;
                transform: translateX(-50%);
                width: calc(100% - 2rem);
                max-width: 24rem;
                display: flex;
                justify-content: space-around;
                background: rgba(15, 23, 42, 0.96);
                color: #e2e8f0;
                border-radius: 20px;
                padding: 0.5rem 0.35rem;
                box-shadow: 0 18px 40px rgba(15, 23, 42, 0.32);
                backdrop-filter: blur(20px);
                z-index: 1300;
            }
            .ios-bottom-nav a,
            .ios-bottom-nav button {
                flex: 1;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                gap: 0.3rem;
                font-size: 0.72rem;
                font-weight: 500;
                color: inherit;
                padding: 0.35rem 0;
                border: none;
                background: transparent;
                border-radius: 14px;
                transition: background 150ms ease, color 150ms ease;
            }
            .ios-bottom-nav a.active,
            .ios-bottom-nav button.active {
                background: rgba(148, 163, 184, 0.18);
                color: #f8fafc;
            }
            .ios-bottom-nav a:focus-visible,
            .ios-bottom-nav button:focus-visible {
                outline: 2px solid rgba(148, 163, 184, 0.4);
                outline-offset: 2px;
            }
            .ios-bottom-nav .nav-icon {
                font-size: 1.25rem;
                line-height: 1;
            }
            body {
                padding-bottom: 110px;
            }
        }

        .page-chrome { z-index: 900; }
        .page-chrome-low { z-index: 100; }

        .content-dropdown { z-index: 750 !important; }
    </style>
    {# Tenant branding optioneel via instellingen #}
    {% set _brand = tenant_settings.brand if tenant_settings and tenant_settings.brand else {} %}
    {% set _nav_primary = _brand.color %}
    {% set _nav_text_color = _brand.color1 %}
    {% set _nav_hover = _brand.color2 %}
    {% set _nav_border = _brand.color3 %}
    {% if _nav_primary %}
    <style>
      .nav-root { background-color: {{ _nav_primary }} !important; }
      .nav-root a { color: {{ _nav_text_color or '#000000' }} !important; }
      .nav-root a:hover { color: {{ _nav_hover or '#ffffff' }} !important; }
      .nav-root .md\:hover\:text-blue-700:hover { color: {{ _nav_hover or '#ffffff' }} !important; }
      .nav-root .text-blue-700 { color: {{ _nav_hover or '#ffffff' }} !important; }
      .nav-root .hover\:bg-gray-100:hover { background-color: rgba(255,255,255,0.12) !important; }
      .nav-root .border-gray-200 { border-color: {{ _nav_border or 'rgba(255,255,255,0.2)' }} !important; }
    </style>
    {% endif %}
    <script>
        // Optionele config (kleuren, container, fonts, safelist, dark mode, etc.)
        tailwind.config = {
            darkMode: 'class',
            theme: {
                container: { center: true, padding: '1rem' },
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#0ea5e9',
                            dark: '#0369a1'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', 'Segoe UI', 'Roboto', 'Arial', 'sans-serif']
                    }
                }
            },
            safelist: [
                // classes die je dynamisch toevoegt vanuit Flask/Jinja
                'text-green-600', 'text-red-600', 'bg-yellow-100', 'bg-green-100', 'bg-red-100'
            ]
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>

</head>

<body>
    {% set _current_role = (current_user.role or '').lower() if current_user.is_authenticated else '' %}
    <div class="app-background" aria-hidden="true">
        <div class="app-gradient-overlay"></div>
        <div class="app-blob app-blob--one"></div>
        <div class="app-blob app-blob--two"></div>
        <div class="app-blob app-blob--three"></div>
        <canvas class="app-gradient-canvas" aria-hidden="true"></canvas>
    </div>
    {% set _tenant_display_name = tenant_name or 'Motio' %}
    {% set _tenant_slug_display = (tenant_slug if tenant_slug and tenant_slug != '__global__' else None) %}
    {% if tenant_slug == '__global__' %}
        {% set _tenant_slug_display = 'globaal' %}
    {% endif %}
    <nav class="bg-white/80 backdrop-blur sticky top-0 nav-root border-gray-200 border-b dark:bg-gray-900 dark:border-gray-700">
        <div class="tenant-brand-banner border-b border-white/10 bg-slate-950/40 text-[11px] font-medium text-white/80 tracking-wide print:hidden">
            <div class="max-w-screen-xl mx-auto flex flex-wrap items-center justify-between gap-3 px-4 py-1.5">
                <div class="flex flex-wrap items-center gap-2">
                    <span class="uppercase text-white/60 tracking-[0.3em]">Tenant</span>
                    <span class="text-white font-semibold tracking-normal">{{ _tenant_display_name }}</span>
                    {% if _tenant_slug_display %}
                        <span class="text-white/60 tracking-normal">({{ _tenant_slug_display }})</span>
                    {% endif %}
                </div>
                <div class="flex flex-wrap items-center gap-2 tracking-normal">
                    {% if _nav_primary %}
                        <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-2 py-[2px] text-[11px] font-medium uppercase tracking-[0.18em]">
                            <span class="h-3 w-3 rounded-full border border-white/40 shadow-sm" style="background-color: {{ _nav_primary }};"></span>
                            Primair {{ _nav_primary }}
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-2 py-[2px] text-[11px] font-medium uppercase tracking-[0.18em] text-white/50">
                            Primair n.v.t.
                        </span>
                    {% endif %}
                    {% if _nav_hover %}
                        <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-2 py-[2px] text-[11px] font-medium uppercase tracking-[0.18em]">
                            <span class="h-3 w-3 rounded-full border border-white/40 shadow-sm" style="background-color: {{ _nav_hover }};"></span>
                            Hover {{ _nav_hover }}
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-2 py-[2px] text-[11px] font-medium uppercase tracking-[0.18em] text-white/50">
                            Hover n.v.t.
                        </span>
                    {% endif %}
                    {% if _nav_border %}
                        <span class="inline-flex items-center gap-2 rounded-full border border-white/20 bg-white/10 px-2 py-[2px] text-[11px] font-medium uppercase tracking-[0.18em]">
                            <span class="h-3 w-3 rounded-full border border-white/40 shadow-sm" style="background-color: {{ _nav_border }};"></span>
                            Rand {{ _nav_border }}
                        </span>
                    {% else %}
                        <span class="inline-flex items-center gap-2 rounded-full border border-white/10 bg-white/5 px-2 py-[2px] text-[11px] font-medium uppercase tracking-[0.18em] text-white/50">
                            Rand n.v.t.
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
            <a href="{{ url_for('dashboard.home') }}" class="flex items-center space-x-3 rtl:space-x-reverse">
                {% set _logo = None %}
                {% if tenant_settings and tenant_settings.logo_src %}
                    {% set _logo = tenant_settings.logo_src %}
                {% elif tenant_slug and tenant_slug != "__global__" %}
                    {% set _logo = url_for('static', filename='tenants/' ~ tenant_slug ~ '/logo.png') %}
                {% endif %}
                <img src="{{ _logo or url_for('static', filename='img/logo_banner.png') }}" class="h-8" alt="{{ tenant_name or 'Motio' }} Logo" />
            </a>
                        <!-- Notifications (bell) -->

            <div class="flex items-center md:order-2 space-x-3 md:space-x-0 rtl:space-x-reverse">
                <button type="button"
                    class="flex text-sm bg-gray-800 rounded-full md:me-0 focus:ring-4 focus:ring-gray-300 dark:focus:ring-gray-600"
                    id="user-menu-button" aria-expanded="false" data-dropdown-toggle="user-dropdown"
                    data-dropdown-placement="bottom">
                    <span class="sr-only">Open user menu</span>
                    <img class="w-8 h-8 rounded-full" src="{{ current_user.profile_src }}" alt="user photo">
                </button>
                <!-- Dropdown menu -->
                <div class="z-[1200] nav-dropdown z-50 hidden my-4 w-60 text-base list-none bg-white divide-y divide-gray-100 rounded-lg shadow-sm dark:bg-gray-700 dark:divide-gray-600"
                    id="user-dropdown">
                    <div class="px-4 py-3">
                        <span class="block text-sm text-gray-900 dark:text-white">{{ current_user.naam }}</span>
                        <span class="block text-sm  text-gray-500 truncate dark:text-gray-400">{{
                            current_user.partij.naam }}</span>
                    </div>
                    <ul class="py-2" aria-labelledby="user-menu-button">
                        <li>
                            <a href="{{ url_for('gebruikers.view_profiel') }}"
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white">Profiel</a>
                        </li>
                        <li>
                            <a href="{{ url_for('gebruikers.settings') }}"
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white">Instellingen</a>
                        </li>
                        {% if (current_user.email or '').lower() == 'floris@florisdeboer.com' %}
                        <li>
                            <a href="{{ url_for('settings.application_access') }}"
                               class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white">Tenant instellingen</a>
                        </li>
                        {% endif %}
                        <li>
                            <a href="{{ url_for('auth.logout', user_id=current_user.id) }}"
                                class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 dark:text-gray-200 dark:hover:text-white">Uitloggen</a>
                        </li>
                    </ul>
                </div>
            <div class="relative me-3 px-2">
            <button
                type="button"
                id="notif-button"
                class="relative inline-flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-4 focus:ring-gray-300 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
                aria-expanded="false"
                aria-controls="notif-dropdown"
                data-dropdown-toggle="notif-dropdown"
                data-dropdown-placement="bottom"
            >
                <span class="sr-only">Open notificaties</span>
                <i class="fa-regular fa-bell text-gray-700 dark:text-gray-200"></i>

                {% set _unread = notif_unread|default(0) %}
                {% if _unread > 0 %}
                    <span
                    class="absolute -top-0.5 -right-0.5 min-w-[1.1rem] h-4 px-1 inline-flex items-center justify-center
                                text-[10px] leading-none font-semibold text-white bg-red-600 rounded-full
                                ring-2 ring-white dark:ring-gray-800">
                    {{ _unread if _unread < 100 else '99+' }}
                    </span>
                {% endif %}
            </button>

            <!-- Dropdown -->
            <div id="notif-dropdown"
                class="z-50 nav-dropdown z-[1200] hidden my-4 px-2 w-80 max-w-[90vw] text-sm bg-white rounded-lg shadow-sm border border-gray-100 dark:bg-gray-800 dark:border-gray-700">
                <div class="px-4 py-3 border-b border-gray-100 dark:border-gray-700 flex items-center justify-between">
                <div class="font-medium">Notificaties</div>
                <a href="{{ url_for('gebruikers.mark_all_read') }}"
                    class="text-xs text-blue-600 hover:underline">Alles lezen</a>
                </div>

                <ul class="max-h-96 overflow-auto divide-y divide-gray-100 dark:divide-gray-700">
                {# veilig fallbacken als lijst (nog) niet wordt meegegeven #}
                {% set _notifs = (notifications if notifications is defined else []) %}
                {% for n in _notifs[:10] %}
                    <li>
                    {% set _target = None %}
                    {% if n.motie_id %}
                        {% if n.type == 'advice_requested' %}
                            {% set _target = url_for('griffie.advies_bewerken', motie_id=n.motie_id) %}
                        {% elif n.type == 'advice_returned' %}
                            {% set _target = url_for('moties.advies_review', motie_id=n.motie_id) %}
                        {% elif n.type == 'advice_accepted' %}
                            {% set _target = url_for('griffie.advies_inbox') %}
                        {% else %}
                            {% set _target = url_for('moties.bekijken', motie_id=n.motie_id) %}
                        {% endif %}
                    {% endif %}
                    <a href="{% if _target %}{{ url_for('gebruikers.open', notification_id=n.id, next=_target) }}{% else %}{{ url_for('gebruikers.open', notification_id=n.id) }}{% endif %}"
                        class="flex gap-3 px-4 py-3 hover:bg-gray-50 dark:hover:bg-gray-700 {% if not n.read_at %}bg-blue-50/50 dark:bg-blue-900/20{% endif %}">
                        <div class="pt-0.5">
                        {% if n.type == 'share_received' %}
                            <i class="fa-solid fa-user-plus"></i>
                        {% elif n.type == 'share_revoked' %}
                            <i class="fa-solid fa-user-xmark"></i>
                        {% elif n.type == 'coauthor_added' %}
                            <i class="fa-solid fa-pen-to-square"></i>
                        {% elif n.type == 'advice_requested' %}
                            <i class="fa-solid fa-clipboard-list"></i>
                        {% elif n.type == 'advice_returned' %}
                            <i class="fa-solid fa-comments"></i>
                        {% elif n.type == 'advice_accepted' %}
                            <i class="fa-solid fa-check"></i>
                        {% else %}
                            <i class="fa-regular fa-bell"></i>
                        {% endif %}
                        </div>
                        <div class="min-w-0">
                        <p class="font-medium text-gray-900 dark:text-gray-100">
                            {% if n.type == 'share_received' %}Motie met jou gedeeld door {{ n.payload.afzender_naam }}
                            {% elif n.type == 'share_revoked' %}Toegang ingetrokken {{ n.payload.revoked_by_naam }}
                            {% elif n.type == 'coauthor_added' %}Toegevoegd als mede-indiener
                            {% elif n.type == 'advice_requested' %}Advies aangevraagd door {{ n.payload.requested_by_naam }}
                            {% elif n.type == 'advice_returned' %}Advies teruggestuurd door {{ n.payload.reviewer_naam }}
                            {% elif n.type == 'advice_accepted' %}Advies geaccepteerd door {{ n.payload.accepted_by_naam }}
                            {% else %}Notificatie{% endif %}
                        </p>
                        <p class="text-gray-600 dark:text-gray-300 truncate">
                            {{ (n.payload.motie_titel if n.payload and 'motie_titel' in n.payload else ('Motie #' ~ n.motie_id)) }}
                        </p>
                        <p class="text-xs text-gray-400">{{ n.created_at.strftime('%d-%m-%Y %H:%M') }}</p>
                        </div>
                        {% if not n.read_at %}
                        <span class="ml-auto mt-1 w-2 h-2 rounded-full bg-blue-600"></span>
                        {% endif %}
                    </a>
                    </li>
                {% else %}
                    <li class="px-4 py-6 text-gray-500">Geen nieuwe notificaties.</li>
                {% endfor %}
                </ul>

                <div class="px-4 py-2 border-t border-gray-100 dark:border-gray-700">
                <a href=""
                    class="block text-center text-sm text-blue-600 hover:underline">Alle notificaties bekijken</a>
                </div>
            </div>
            </div>
            </div>
            <button data-collapse-toggle="navbar-dropdown" type="button"
                class="inline-flex items-center p-2 w-10 h-10 justify-center text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600"
                aria-controls="navbar-dropdown" aria-expanded="false">
                <span class="sr-only">Open menu</span>
                <svg class="w-5 h-5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 17 14">
                    <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M1 1h15M1 7h15M1 13h15" />
                </svg>
            </button>
            <div class="nav-dropdown ios-nav hidden w-full md:block z-[1200] md:w-auto" id="navbar-dropdown">
                <ul
                    class="flex flex-col font-medium p-4 md:p-0 mt-4 border border-gray-100 rounded-lg md:flex-row md:mt-0 md:border-0 md:space-x-6 md:pl-3 dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
                    {% if _current_role != 'bestuursadviseur' %}
                    <li>
                        <a href="{{ url_for('dashboard.home') }}"
                           class="block bg-transparent py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:px-3 md:py-2 dark:text-white md:dark:hover:text-blue-500 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">
                            Dashboard
                        </a>
                    </li>
                    {% endif %}
                    {% if user_has_role('gebruiker','griffie','superadmin') %}
                    <li class="relative md:static">
                        <button id="dropdownMotiesLink"
                                data-dropdown-toggle="dropdownMoties"
                                class="flex items-center justify-between w-full py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:px-3 md:py-2 md:w-auto dark:text-white md:dark:hover:text-blue-500 dark:focus:text-white dark:border-gray-700 dark:hover:bg-gray-700 md:dark:hover:bg-transparent">
                            Moties
                            <svg class="w-2.5 h-2.5 ms-2.5 ios-chevron" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" />
                            </svg>
                        </button>
                        <div id="dropdownMoties"
                             class="nav-dropdown-panel hidden font-normal bg-white divide-y divide-gray-100 rounded-lg shadow-lg w-full md:w-64 dark:bg-gray-700 dark:divide-gray-600 md:absolute md:left-0 md:top-full md:mt-1">
                            <ul class="py-2 text-sm text-gray-700 dark:text-gray-400" aria-labelledby="dropdownMotiesLink">
                                {% if user_has_role('gebruiker') or user_has_role('superadmin') %}
                                <li>
                                    <a href="{{ url_for('moties.index_personal') }}"
                                       class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Mijn moties</a>
                                </li>
                                {% endif %}
                                {% if user_has_role('griffie') %}
                                <li>
                                    <a href="{{ url_for('griffie.advies_inbox') }}"
                                       class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Adviesaanvragen</a>
                                </li>
                                <li>
                                    <a href="{{ url_for('griffie.indienen_index') }}"
                                       class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Klaar om in te dienen</a>
                                </li>
                                {% endif %}
                                {% if user_has_role('superadmin') %}
                                <li>
                                    <a href="{{ url_for('moties.index') }}"
                                       class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Alle moties</a>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </li>
                    {% endif %}
                    {% if user_has_role('gebruiker','griffie','superadmin') %}
                    <li class="relative md:static">
                        <button id="dropdownRaadLink"
                                data-dropdown-toggle="dropdownRaad"
                                class="flex items-center justify-between w-full py-2 px-3 text-gray-900 rounded-sm hover:bg-gray-100 md:hover:bg-transparent md:border-0 md:hover:text-blue-700 md:px-3 md:py-2 md:w-auto dark:text-white md:dark:hover:text-blue-500 dark:focus:text-white dark:border-gray-700 dark:hover:bg-gray-700 md:dark:hover:bg-transparent">
                            Raad
                            <svg class="w-2.5 h-2.5 ms-2.5 ios-chevron" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" />
                            </svg>
                        </button>
                        <div id="dropdownRaad"
                             class="nav-dropdown-panel hidden font-normal bg-white divide-y divide-gray-100 rounded-lg shadow-lg w-full md:w-60 dark:bg-gray-700 dark:divide-gray-600 md:absolute md:left-0 md:top-full md:mt-1">
                            <ul class="py-2 text-sm text-gray-700 dark:text-gray-400" aria-labelledby="dropdownRaadLink">
                                <li>
                                    <a href="{{ url_for('gebruikers.index') if user_has_role('griffie','superadmin') else url_for('gebruikers.index_user') }}"
                                       class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Gebruikers</a>
                                </li>
                                <li>
                                    <a href="{{ url_for('partijen.index') }}"
                                       class="block px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white">Partijen</a>
                                </li>
                            </ul>
                        </div>
                    </li>

                    {% endif %}
                    {% if user_has_role('griffie','superadmin') %}
                    <li class="relative md:static">
                        <button id="dropdownBeheerLink"
                                data-dropdown-toggle="dropdownBeheer"
                                class="flex items-center justify-between w-full py-2 px-3 text-emerald-600 rounded-sm hover:bg-emerald-50 md:hover:bg-transparent md:border-0 md:hover:text-emerald-500 md:px-3 md:py-2 md:w-auto dark:text-emerald-300 dark:hover:text-emerald-200 dark:border-gray-700 dark:hover:bg-gray-700 md:dark:hover:bg-transparent">
                            Beheer
                            <svg class="w-2.5 h-2.5 ms-2.5 ios-chevron" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" />
                            </svg>
                        </button>
                        <div id="dropdownBeheer"
                             class="nav-dropdown-panel hidden font-normal bg-white divide-y divide-gray-100 rounded-lg shadow-lg w-full md:w-60 dark:bg-gray-700 dark:divide-gray-600 md:absolute md:left-0 md:top-full md:mt-1">
                            <ul class="py-2 text-sm text-gray-700 dark:text-gray-400" aria-labelledby="dropdownBeheerLink">
                                <li>
                                    {% if route_exists is defined and route_exists('griffie.toepassingen') %}
                                    <a href="{{ url_for('griffie.toepassingen') }}"
                                       class="block px-4 py-2 hover:bg-emerald-50 hover:text-emerald-700 dark:hover:bg-gray-600 dark:hover:text-white">Toepassingen</a>
                                    {% else %}
                                    <span class="block px-4 py-2 text-gray-400 dark:text-gray-500">Toepassingen</span>
                                    {% endif %}
                                </li>
                                <li>
                                    <a href="{{ url_for('gebruikers.index') }}"
                                       class="block px-4 py-2 hover:bg-emerald-50 hover:text-emerald-700 dark:hover:bg-gray-600 dark:hover:text-white">Gebruikers beheren</a>
                                </li>
                                <li>
                                    <a href="{{ url_for('partijen.index') }}"
                                       class="block px-4 py-2 hover:bg-emerald-50 hover:text-emerald-700 dark:hover:bg-gray-600 dark:hover:text-white">Partijen beheren</a>
                                </li>
                            </ul>
                        </div>
                    </li>
                    {% endif %}
                    {% if _current_role == 'bestuursadviseur' %}
                    <li>
                        <a href="{{ url_for('griffie.toepassingen') }}"
                           class="block bg-transparent py-2 px-3 text-emerald-700 rounded-sm hover:bg-emerald-50 md:hover:bg-transparent md:border-0 md:hover:text-emerald-500 md:px-3 md:py-2 dark:text-emerald-300 md:dark:hover:text-emerald-200 dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent">
                            Toepassingen
                        </a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>
    {% set _endpoint = request.endpoint or '' %}
    <nav class="ios-bottom-nav md:hidden" aria-label="Mobiele hoofdmenu">
        {% set _home_href = url_for('dashboard.home') %}
        {% set _home_active = (_endpoint.startswith('dashboard.') or _endpoint == 'dashboard_home') %}
        {% set _home_label = 'Home' %}
        {% if _current_role == 'bestuursadviseur' and route_exists('griffie.toepassingen') %}
            {% set _home_href = url_for('griffie.toepassingen') %}
            {% set _home_active = _endpoint.startswith('griffie.toepassingen') %}
            {% set _home_label = 'Toepassingen' %}
        {% endif %}
        <a href="{{ _home_href }}"
           class="{% if _home_active %}active{% endif %}"
           aria-label="{{ _home_label }}">
            <i class="fa-solid fa-house nav-icon"></i>
            <span>{{ _home_label }}</span>
        </a>
        {% set _moties_target = None %}
        {% if user_has_role('griffie') %}
            {% set _moties_target = url_for('griffie.advies_inbox') %}
        {% elif user_has_role('gebruiker') or user_has_role('superadmin') %}
            {% set _moties_target = url_for('moties.index_personal') %}
        {% endif %}
        {% if _moties_target %}
        <a href="{{ _moties_target }}"
           class="{% if _endpoint.startswith('moties.') or _endpoint.startswith('griffie.advies') or _endpoint.startswith('griffie.indienen') %}active{% endif %}"
           aria-label="Moties">
            <i class="fa-solid fa-file-lines nav-icon"></i>
            <span>Moties</span>
        </a>
        {% endif %}

        {% if user_has_role('gebruiker','griffie','superadmin') %}
        <a href="{{ url_for('gebruikers.index') if user_has_role('griffie','superadmin') else url_for('gebruikers.index_user') }}"
           class="{% if _endpoint.startswith('gebruikers.') %}active{% endif %}"
           aria-label="Gebruikers">
            <i class="fa-solid fa-user-group nav-icon"></i>
            <span>Gebruikers</span>
        </a>
        {% endif %}

        {% if user_has_role('gebruiker','griffie','superadmin') %}
        <a href="{{ url_for('partijen.index') }}"
           class="{% if _endpoint.startswith('partijen.') %}active{% endif %}"
           aria-label="Partijen">
            <i class="fa-solid fa-people-group nav-icon"></i>
            <span>Partijen</span>
        </a>
        {% endif %}

        {% if user_has_role('griffie','superadmin') and route_exists('griffie.toepassingen') %}
        <a href="{{ url_for('griffie.toepassingen') }}"
           class="{% if _endpoint.startswith('griffie.dashboard') or _endpoint.startswith('griffie.toepassingen') %}active{% endif %}"
           aria-label="Beheer">
            <i class="fa-solid fa-puzzle-piece nav-icon"></i>
            <span>Beheer</span>
        </a>
        {% endif %}
        <button type="button"
                data-collapse-toggle="navbar-dropdown"
                aria-controls="navbar-dropdown"
                aria-expanded="false"
                class="menu-trigger"
                aria-label="Meer opties">
            <i class="fa-solid fa-ellipsis nav-icon"></i>
            <span>Meer</span>
        </button>
    </nav>
    <div class="relative">
        <div class="container mt-8">
            {% with messages = get_flashed_messages(with_categories=True) %}
            {% if messages %}
            {% for category, message in messages %}
            <div class="
                p-4 mb-4 rounded-lg border
                {% if category == 'success' %} text-green-800 border-green-300 bg-green-50
                {% elif category in ['error','danger'] %} text-red-800 border-red-300 bg-red-50
                {% elif category == 'warning' %} text-yellow-800 border-yellow-300 bg-yellow-50
                {% else %} text-gray-800 border-gray-300 bg-gray-50
                {% endif %}
              ">
                {{ message }}
            </div>
            {% endfor %}
            {% endif %}
            {% endwith %}
            {% block content %}{% endblock %}
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js" defer></script>
    <script>
        function initChoices(selector = '.choices-multi') {
            const nodes = document.querySelectorAll(selector);
            nodes.forEach((el) => {
                if (!el || el.dataset.choicesInit === '1') return;

                // Init Choices (let op: geen spaties in classNames -> 1 token!)
                const instance = new Choices(el, {
                    removeItemButton: true,
                    searchEnabled: true,
                    shouldSort: false,
                    placeholder: true,
                    placeholderValue: el.dataset.placeholder || 'Kies…',
                    itemSelectText: 'Klik om te selecteren',
                    noResultsText: 'Geen resultaten',
                    noChoicesText: 'Geen opties',
                    classNames: {
                        containerOuter: 'choices' // laat default staan; geen extra class met spatie!
                    }
                });

                // Voeg onze extra styling-class apart toe (nu mag dat wél)
                try { instance.containerOuter.element.classList.add('custom-choices'); } catch (e) { }

                el.dataset.choicesInit = '1';
                el._choices = instance;
            });
        }

        // Veilig initialiseren (element kan ontbreken → geen error)
        document.addEventListener('DOMContentLoaded', () => initChoices());

        // Als je htmx/Turbo/nav gebruikt en content wisselt:
        document.addEventListener('htmx:afterSwap', () => initChoices());
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.querySelector('.app-gradient-canvas');
            if (!(canvas instanceof HTMLCanvasElement)) {
                return;
            }

            const ctx = canvas.getContext('2d', { alpha: true });
            if (!ctx) return;

            const prefersReduce = window.matchMedia('(prefers-reduced-motion: reduce)');
            const schemeWatcher = window.matchMedia('(prefers-color-scheme: dark)');
            let frameId = 0;
            let width = 0;
            let height = 0;

            const palettes = {
                light: [
                    { hue: 214, saturation: 82, lightness: 66 },
                    { hue: 195, saturation: 88, lightness: 60 },
                    { hue: 268, saturation: 78, lightness: 68 },
                    { hue: 205, saturation: 86, lightness: 64 },
                ],
                dark: [
                    { hue: 222, saturation: 70, lightness: 46 },
                    { hue: 198, saturation: 68, lightness: 42 },
                    { hue: 268, saturation: 74, lightness: 48 },
                    { hue: 204, saturation: 70, lightness: 44 },
                ],
            };

            const isDark = () =>
                document.documentElement.classList.contains('dark') || schemeWatcher.matches;

            const resize = () => {
                const rect = canvas.getBoundingClientRect();
                const dpr = Math.min(window.devicePixelRatio || 1, 2);
                width = rect.width;
                height = rect.height;
                canvas.width = rect.width * dpr;
                canvas.height = rect.height * dpr;
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.scale(dpr, dpr);
            };

            const paint = (t = 0) => {
                if (!width || !height) return;
                ctx.clearRect(0, 0, width, height);

                const palette = isDark() ? palettes.dark : palettes.light;
                const gradient = ctx.createLinearGradient(0, 0, width, height);
                const timeFactor = t * 1.4; // sneller verloop
                palette.forEach((base, index) => {
                    const stop = index / (palette.length - 1 || 1);
                    const hue = (base.hue + timeFactor * 24 + Math.sin(timeFactor * 0.9 + index) * 12) % 360;
                    const light = Math.min(
                        92,
                        Math.max(
                            isDark() ? 28 : 42,
                            base.lightness + Math.sin(timeFactor * 1.1 + index * 1.6) * 10,
                        ),
                    );
                    const alpha = isDark() ? 0.55 : 0.82;
                    gradient.addColorStop(stop, `hsla(${hue.toFixed(1)}, ${base.saturation}%, ${light.toFixed(1)}%, ${alpha})`);
                });
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, width, height);

                const highlight = ctx.createRadialGradient(
                    width * 0.2,
                    height * 0.25,
                    height * 0.24,
                    width * 0.75,
                    height * 0.75,
                    width * 1.2,
                );
                highlight.addColorStop(0, isDark() ? 'rgba(255,255,255,0.12)' : 'rgba(255,255,255,0.26)');
                highlight.addColorStop(1, 'rgba(255,255,255,0)');
                ctx.fillStyle = highlight;
                ctx.fillRect(0, 0, width, height);
            };

            const render = (now) => {
                const t = now / 650; // versnelt animatie
                paint(t);
                frameId = requestAnimationFrame(render);
            };

            const start = () => {
                if (frameId) {
                    cancelAnimationFrame(frameId);
                    frameId = 0;
                }
                resize();
                if (prefersReduce.matches) {
                    paint(0);
                } else {
                    frameId = requestAnimationFrame(render);
                }
            };

            start();

            window.addEventListener('resize', start, { passive: true });
            const addMediaListener = (mq, handler) => {
                if (!mq) return;
                if (typeof mq.addEventListener === 'function') {
                    mq.addEventListener('change', handler);
                } else if (typeof mq.addListener === 'function') {
                    mq.addListener(handler);
                }
            };
            addMediaListener(prefersReduce, start);
            addMediaListener(schemeWatcher, start);
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const body = document.body;
            if (!body) return;

            const anyModalVisible = () =>
                Array.from(document.querySelectorAll('.modal-topmost')).some((modal) => {
                    const hiddenAttr = modal.getAttribute('aria-hidden');
                    return !modal.classList.contains('hidden') && hiddenAttr !== 'true';
                });

            const updateModalState = () => {
                if (anyModalVisible() || document.querySelector('[modal-backdrop]')) {
                    body.classList.add('modal-open');
                } else {
                    body.classList.remove('modal-open');
                }
            };

            document.querySelectorAll('.modal-topmost').forEach((modal) => {
                modal.addEventListener('show.tw.modal', () => {
                    body.classList.add('modal-open');
                });
                modal.addEventListener('shown.tw.modal', () => {
                    body.classList.add('modal-open');
                });
                const onClose = () => {
                    setTimeout(updateModalState, 0);
                };
                modal.addEventListener('hide.tw.modal', onClose);
                modal.addEventListener('hidden.tw.modal', onClose);
            });

            const observer = new MutationObserver(() => updateModalState());
            observer.observe(document.body, { childList: true });
            updateModalState();
        });
    </script>
</body>

</html>
